% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/Support_Analysis_SIVScoring.R
\name{neighborhood_plot2}
\alias{neighborhood_plot2}
\title{Plot a gene- or feature-specific cell neighborhood}
\usage{
neighborhood_plot2(
  cell_meta,
  cell_polygons,
  expr_matrix = NULL,
  coi = NULL,
  k = 50,
  restrict_to_sample = TRUE,
  cluster_var = "RNA_Pre.Napari.v3.0.071825_Cell.Typing.InSituType.2_1_clusters",
  fill_by = c("VirusPos", "cluster", "SIVsum", "gene"),
  gene = NULL,
  gene_transform = c("none", "log1p", "sqrt"),
  alpha_coi = 1,
  alpha_bg = 0.6,
  outline_coi = "black",
  outline_bg = "grey40",
  linewidth = 0.25,
  scale_bar_fun = make_scale_bar_r,
  seed = 2025
)
}
\arguments{
\item{cell_meta}{Data frame of per-cell metadata including
`cell`, `CenterX_global_px`, and `CenterY_global_px`.}

\item{cell_polygons}{Data frame of per-cell polygon coordinates including
`cell`, `x_global_px`, and `y_global_px`.}

\item{expr_matrix}{Optional numeric expression matrix (cells × genes), required
when using `fill_by = "gene"`, or when `SIVsum` is not in `cell_meta`.}

\item{coi}{Character. Cell ID for the cell of interest; if `NULL`, defaults
to the cell with the highest `SIVsum`.}

\item{k}{Integer. Number of nearest neighbors to include (default: `50`).}

\item{restrict_to_sample}{Logical. If `TRUE`, restricts to neighbors within
the same `SampleID` (default: `TRUE`).}

\item{cluster_var}{Character. Column defining cell type or cluster identity.}

\item{fill_by}{Character. Variable used to color polygons:
`"VirusPos"`, `"cluster"`, `"SIVsum"`, or `"gene"`.}

\item{gene}{Character. Target gene to visualize when `fill_by = "gene"`.}

\item{gene_transform}{Character. Transformation applied to gene expression:
`"none"`, `"log1p"`, or `"sqrt"`.}

\item{alpha_coi, alpha_bg}{Numeric transparency values for COI and neighbors.}

\item{outline_coi, outline_bg}{Colors for polygon outlines.}

\item{linewidth}{Numeric. Border line width for polygons.}

\item{scale_bar_fun}{Function providing scale bar annotations (default:
`make_scale_bar_r`); use `NULL` to skip.}

\item{seed}{Integer. Random seed for reproducibility.}
}
\value{
A `ggplot2` object showing neighborhood polygons colored by the
  specified variable. The plot carries attributes:
  \itemize{
    \item `"coi"` — the cell of interest.
    \item `"neighbors"` — vector of neighboring cell IDs.
    \item `"gene"` — gene name when `fill_by = "gene"`.
  }
}
\description{
Extends \code{\link{neighborhood_plot}} to support visualization of local
gene expression patterns in addition to viral status, cluster identity, or
SIV summary signal.
}
\details{
This function provides flexible visualization of local spatial environments
for a given cell. When `fill_by = "gene"`, expression values are retrieved
from `expr_matrix` and optionally transformed for dynamic range compression.
Color scales adapt automatically (viridis continuous for numeric values).
}
\examples{
p_gene <- neighborhood_plot2(
  cell_meta, cell_polygons, expr_matrix,
  fill_by = "gene", gene = "CD3E", gene_transform = "log1p"
)
print(p_gene)

}
\seealso{
[neighborhood_plot()], [make_scale_bar_r()]
}
